<template>
  <my-k-line ref="myKLine" @tabSelected="echartsTabSelected" @dataZoomLeft="echartsDataZoomLeft" :pair="pair" :usdt-rate="usdtRate" :loading-status="echartsLoadingStatus" :depth-loading-status="echartsDepthLoadingStatus"/>
</template>
<script>
import myKLine from '../../components/my-k-line/index'
import {mapActions, mapGetters} from "vuex";
import {marketDepthList} from "../../api/market/depth";
import {marketKLineList} from "../../api/market/kLine";

export default {
  computed: {
    ...mapGetters({
      pair: "pair",
      usdtRate: "usdtRate",
    }),
  },
  components: {
    myKLine
  },
  data() {
    return {
      params: {
        tradeCoinId: "",
        coinId: "",
      },
      echartsLoadingStatus: 'loading',
      echartsDepthLoadingStatus: 'loading',
    };
  },
  onReady() {
    this.setPair(this.params)
        .then(b => {
          // 获取K线
          this.getKLine(false)
          // 获取深度图
          this.getDepth()
        })
    let kLineData = [
      [1073260800, 10411.85, 10544.07, 10411.85, 10575.92, 221290000],
      [1073347200, 10543.85, 10538.66, 10454.37, 10584.07, 191460000],
      [1073433600, 10535.46, 10529.03, 10432.12, 10587.55, 225490000],
      [1073520000, 10530.07, 10592.44, 10480.59, 10651.99, 237770000],
      [1073606400, 10589.25, 10458.89, 10420.52, 10603.48, 223250000],
      [1073865600, 10461.55, 10485.18, 10389.85, 10543.03, 197960000],
      [1073952000, 10485.18, 10427.18, 10341.19, 10539.25, 197310000],
      [1074038400, 10428.67, 10538.37, 10426.89, 10573.85, 186280000],
      [1074124800, 10534.52, 10553.85, 10454.52, 10639.03, 260090000],
      [1074211200, 10556.37, 10600.51, 10503.71, 10666.88, 254170000],
      [1074556800, 10601.42, 10528.66, 10447.92, 10676.96, 224300000],
      [1074643200, 10522.77, 10623.62, 10453.11, 10665.72, 214920000],
      [1074729600, 10624.22, 10623.18, 10545.03, 10717.41, 219720000],
      [1074816000, 10625.25, 10568.29, 10490.14, 10691.77, 234260000],
      [1075075200, 10568.12, 10702.51, 10510.44, 10725.18, 186170000],
      [1075161600, 10701.11, 10609.92, 10579.33, 10748.81, 206560000],
      [1075248000, 10610.07, 10468.37, 10412.44, 10703.25, 247660000],
      [1075334400, 10467.41, 10510.29, 10369.92, 10611.56, 273970000],
      [1075420800, 10510.22, 10488.07, 10385.56, 10551.03, 208990000],
      [1075680000, 10487.78, 10499.18, 10395.55, 10614.44, 224800000],
      [1075766400, 10499.48, 10505.18, 10414.15, 10571.48, 183810000],
      [1075852800, 10503.11, 10470.74, 10394.81, 10567.85, 227760000],
      [1075939200, 10469.33, 10495.55, 10399.92, 10566.37, 187810000],
      [1076025600, 10494.89, 10593.03, 10433.74, 10634.81, 182880000],
      [1076284800, 10592.41, 10579.03, 10433.72, 10634.81, 160720000],
      [1076371200, 10578.74, 10613.85, 10511.18, 10667.03, 160590000],
      [1076457600, 10605.48, 10737.72, 10561.55, 10779.41, 277850000],
      [1076544000, 10735.18, 10694.07, 10636.44, 10775.03, 197560000],
      [1076630400, 10696.22, 10627.85, 10578.66, 10755.47, 208340000],
      [1076976000, 10628.88, 10714.88, 10628.88, 10762.07, 169730000],
      [1077062400, 10706.68, 10671.99, 10623.62, 10764.36, 164370000],
      [1077148800, 10674.59, 10664.73, 10626.44, 10794.95, 219890000],
      [1077235200, 10666.29, 10619.03, 10559.11, 10722.77, 220560000],
      [1077494400, 10619.55, 10609.62, 10508.89, 10711.84, 229950000],
      [1077580800, 10609.55, 10566.37, 10479.33, 10681.41, 225670000],
      [1077667200, 10566.59, 10601.62, 10509.42, 10660.73, 192420000],
      [1077753600, 10598.14, 10580.14, 10493.71, 10652.96, 223230000],
      [1077840000, 10581.55, 10583.92, 10519.03, 10689.55, 200050000],
    ];
    let buyData = [
      [28408, 2.7],
      [28412.73, 2.98],
      [28420, 36.5088],
      [28431.52, 0.069],
      [28440.11, 0.0608],
      [28443.62, 0.0608],
      [28444.44, 0.9451],
      [28451, 0.9665],
      [28456.25, 1.19],
      [28460, 9.0055],
      [28498.21, 3.2],
      [28499, 0.3934],
      [28500, 0.0608],
      [28500.01, 0.0342],
      [28501, 0.4637],
      [28502, 0.172],
      [28508, 15.2143],
      [28509.23, 0.0034],
      [28510, 0.0806],
      [28512, 0.0347],
      [28522.67, 0.3006],
      [28529.81, 0.4549],
      [28538, 0.05],
      [28538.03, 0.4879],
      [28543, 0.1722],
      [28545, 0.01],
      [28555, 0.0684],
      [28560, 0.7],
      [28561, 1.0337],
      [28567.1, 0.1343],
      [28588, 0.1251],
      [28600, 0.5],
      [28608, 0.1802],
      [28613, 0.4676],
      [28613.6, 0.1],
      [28617.97, 0.12],
      [28625.8, 12.7248],
      [28640.04, 0.1118],
      [28650, 0.002],
      [28651, 0.0133],
      [28651.99, 1.87],
      [28656, 0.7071],
      [28658, 0.7],
      [28660, 0.321],
      [28665, 0.0075],
      [28668, 0.123],
      [28679.92, 0.0035],
      [28683.22, 1.09],
      [28692, 0.06],
      [28699, 0.18],
      [28700, 0.0347],
      [28701.02, 1.7601],
      [28701.05, 0.0035],
      [28703.03, 0.004],
      [28703.06, 0.55],
      [28708, 1.1],
      [28715.22, 1],
      [28723.22, 1.1176],
      [28725.22, 0.2193],
      [28731.15, 0.1],
      [28735, 0.45],
      [28736, 0.1404],
      [28737, 0.1],
      [28737.18, 3.201],
      [28738.97, 0.02],
      [28740, 0.0693],
      [28750, 0.02],
      [28750.03, 0.5],
      [28750.22, 10],
      [28752, 0.3888],
      [28753, 1],
      [28756.74, 0.7],
      [28780, 1.1127],
      [28780.06, 0.1],
      [28797.03, 1.2749],
      [28800, 0.5],
      [28808, 0.093],
      [28822.89, 3.2505],
      [28822.92, 2.027],
      [28847, 7.1862],
      [28850, 0.12],
      [28855.53, 0.5688],
      [28855.56, 0.6852],
      [28856, 2.6797],
      [28860, 3.3747],
      [28866, 0.2347],
      [28871.66, 0.3806],
      [28882, 0.3581],
      [28888, 0.0262],
      [28888.88, 0.0815],
      [28889, 0.7705],
      [28890, 0.15],
      [28900, 0.4],
      [28901, 0.3],
      [28908, 0.1],
      [28915.73, 0.7],
      [28932.8, 0.5],
      [28937, 0.7],
      [28940, 1.8122],
      [28942, 1.8774],
      [28943.53, 0.3356],
      [28950, 1],
      [28955.03, 0.6],
      [28960.03, 0.0935],
      [28961, 0.1187],
      [28961.31, 0.098],
      [28962.09, 0.3489],
      [28973.4, 0.01],
      [28980, 0.2],
      [28981.52, 0.015],
      [28993.91, 1.8931],
      [28999, 0.923],
      [28999.88, 0.2283],
      [29000, 0.0587],
      [29002, 0.7],
      [29008, 0.0273],
      [29010, 0.2],
      [29010.03, 0.1],
      [29010.06, 43.13],
      [29018, 0.02],
      [29020, 1.1214],
      [29022, 0.08],
      [29022.03, 0.374],
      [29050, 0.094],
      [29053, 0.095],
      [29055.13, 0.4039],
      [29066, 0.5],
      [29066.1, 0.094],
      [29068, 10.5],
      [29070, 0.0473],
      [29072, 0.1],
      [29085, 26.5546],
      [29088, 0.01],
      [29100, 0.2191],
      [29100.09, 0.12],
      [29102, 1.4607],
      [29105, 0.891],
      [29106.31, 66.7432],
      [29109.84, 0.05],
      [29109.87, 0.0805],
      [29112.11, 0.4923],
      [29116.62, 5],
      [29128.14, 0.176],
      [29136, 0.3842],
      [29136.52, 0.0348],
      [29145.66, 0.1002],
      [29149, 0.2223],
      [29150, 0.2],
      [29150.03, 0.0389],
      [29150.04, 0.1367],
    ]
    // 反转打印
    // let log = ""
    // for (let i = buyData.length - 1; i >= 0; i--) {
    //   log += `[${buyData[i][0]}, ${buyData[i][1]}],\n`
    // }
    // console.log(log)
    let sellData = [
      [29180, 0.8431],
      [29190, 17.9561],
      [29193.3, 0.1267],
      [29195, 1.2569],
      [29195.8, 1.987],
      [29195.9, 0.0379],
      [29196, 0.0688],
      [29198, 2],
      [29198.97, 1.1],
      [29199, 0.4325],
      [29199.96, 0.69],
      [29199.99, 7.2687],
      [29200, 15.8332],
      [29205, 0.045],
      [29206, 0.5628],
      [29210, 0.4481],
      [29218, 0.3087],
      [29219.99, 0.8113],
      [29220, 1.483],
      [29222, 0.0372],
      [29230, 0.5],
      [29239.97, 0.69],
      [29240, 1.4145],
      [29247.82, 0.54],
      [29247.85, 0.1692],
      [29249.57, 0.88],
      [29249.6, 3.0476],
      [29250, 5.4897],
      [29250.2, 0.036],
      [29257.95, 0.1996],
      [29260, 0.2117],
      [29269.9, 0.005],
      [29270, 0.1431],
      [29271, 0.1278],
      [29274.52, 0.7],
      [29276, 0.2873],
      [29279.88, 0.5],
      [29279.91, 0.7866],
      [29280, 4.7825],
      [29282.97, 0.7],
      [29283, 1],
      [29288, 1.5193],
      [29289, 0.3547],
      [29290, 2.4371],
      [29294.87, 1.1],
      [29294.9, 0.6615],
      [29294.99, 3],
      [29295, 62.085],
      [29296, 0.0299],
      [29297, 0.0027],
      [29298, 12.9111],
      [29298.71, 0.0349],
      [29298.99, 0.0695],
      [29299, 1.0249],
      [29299.8, 0.0829],
      [29299.9, 0.6],
      [29300, 139.0408],
      [29301.03, 0.005],
      [29305, 0.3],
      [29306.5, 0.05],
      [29307.13, 0.0235],
      [29310, 0.001],
      [29329.8, 0.002],
      [29348, 0.2592],
      [29349, 0.3102],
      [29350, 0.9717],
      [29352, 0.0247],
      [29359.97, 0.5],
      [29360, 0.653],
      [29361.1, 0.0752],
      [29379, 1],
      [29380, 0.8802],
      [29383.2, 0.1],
      [29384, 0.0701],
      [29386.8, 0.0313],
      [29388, 2.7401],
      [29388.88, 0.1095],
      [29389.97, 9],
      [29391, 0.0033],
      [29395, 0.0057],
      [29398, 0.25],
      [29399, 0.1362],
      [29400, 27.3543],
      [29400.03, 1],
      [29403.12, 0.0151],
      [29410, 1.0602],
      [29411, 0.009],
      [29420, 0.2153],
      [29424.16, 0.005],
      [29430, 1],
      [29432, 0.1],
      [29439.83, 0.0526],
      [29447.94, 0.7],
      [29447.97, 0.2],
      [29449, 2.05],
      [29449.02, 0.2002],
      [29450, 35.4735],
      [29450.01, 0.4084],
      [29458, 0.5],
      [29460, 0.4114],
      [29466, 1.023],
      [29468, 0.479],
      [29469.98, 0.5],
      [29470, 1.4613],
      [29477.98, 0.15],
      [29480, 4.2707],
      [29486, 10],
      [29488, 1.8672],
      [29488.23, 0.5084],
      [29489, 1.1364],
      [29489.39, 0.6521],
      [29490, 1.659],
      [29495, 0.3763],
      [29496, 0.1933],
      [29498, 1.1052],
      [29499, 98.1815],
      [29499.05, 0.6],
      [29499.8, 0.0359],
      [29499.98, 0.1],
      [29499.99, 0.9883],
      [29500, 173.6089],
      [29500.1, 0.0033],
      [29500.88, 3],
      [29501, 0.0034],
      [29501.19, 0.1],
      [29509, 0.0998],
      [29510, 0.013],
      [29517, 1.0408],
      [29520, 0.25],
      [29522, 0.0041],
      [29522.59, 0.0671],
      [29525, 0.3601],
      [29528, 0.1],
      [29534, 0.003],
      [29536, 4.0088],
      [29540, 0.998],
      [29540.68, 0.005],
      [29543, 0.0034],
      [29544, 0.1065],
      [29545, 0.7064],
      [29546, 0.0077],
      [29546.99, 2],
      [29548.99, 0.2423],
      [29549.01, 0.011],
      [29550, 5.7517],
      [29553, 0.2751],
      [29555, 2.0025],
      [29555.55, 0.1074],
      [29558, 0.3286],
      [29560, 1.013],
    ]
    // setTimeout(() => {
    //   this.$refs.myKLine.init(kLineData, buyData, sellData)
    // }, 450)
    // setTimeout(() => {
    // }, 2000)
  },
  methods: {
    ...mapActions({
      setPair: "setPair"
    }),
    echartsTabSelected(item) {
      this.echartsLoadingStatus = 'loading'
      this.getKLine(false)
      console.log("图表里面的tab点击了", item)
    },
    echartsDataZoomLeft() {
      console.log("到最左边了")
      this.getKLine(true)
    },
    getKLine(isAdd) {
      const params = {
        tradeCoinId: this.pair.tradeCoin.id,
        coinId: this.pair.coin.id,
      }
      marketKLineList(params)
        .then(res => {
          this.echartsLoadingStatus = 'more'
          if (res.code !== 0) {
            return false
          }
          let data = res.data
          // 组装数据，数据意义(下标)：[0]时间，[1]开盘(open)，[2]收盘(close)，[3]最低(lowest)，[4]最高(highest)，[5]数量(vol)
          let kLineData = []
          for (let i = 0; i < data.length; i++) {
            kLineData.push([
                data[i].time,
                data[i].open,
                data[i].close,
                data[i].lowest,
                data[i].highest,
                data[i].vol,
            ])
          }
          if (isAdd) {
            this.$refs.myKLine.addHistoryData(kLineData)
            return false
          }
          this.$refs.myKLine.createKline(kLineData)
        })
    },
    getDepth() {
      const params = {
        tradeCoinId: this.pair.tradeCoin.id,
        coinId: this.pair.coin.id,
      }
      marketDepthList(params)
          .then(res => {
            this.echartsDepthLoadingStatus = 'more'
            if (res.code > 0) {
              this.$tui.toast(t('http.code.' + res.code))
              return false
            }
            let buyList = res.data.buyList ||[]
            let buyData = []
            for (let i = 0; i < buyList.length; i++) {
              buyData.push([
                  buyList[i].amount,
                  buyList[i].price,
              ])
            }
            let sellList = res.data.sellList || []
            let sellData = []
            for (let i = 0; i < sellList.length; i++) {
              sellData.push([
                sellList[i].amount,
                sellList[i].price,
              ])
            }
            this.$refs.myKLine.createDepth(buyData, sellData)
          })
          .catch(() => {
          })
    }
  }
};
</script>


<style>
</style>